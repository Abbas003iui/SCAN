<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Light Spectrum Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      text-align: center;
      padding: 10px;
      max-width: 900px;
      margin: auto;
    }
    h1 {
      margin-bottom: 0;
    }
    p.instructions {
      max-width: 700px;
      margin: 10px auto 20px;
      font-size: 14px;
      color: #333;
      text-align: left;
      background: #fff;
      padding: 12px 15px;
      border-radius: 6px;
      box-shadow: 0 0 6px #ccc;
    }
    input[type="file"] {
      margin: 10px 0 5px;
    }
    canvas {
      max-width: 100%;
      height: 400px !important;
      margin: auto;
      background: white;
      border-radius: 6px;
      box-shadow: 0 0 8px #aaa;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #006400;
    }
    .preview-container {
      margin-bottom: 15px;
    }
    img.preview {
      max-width: 300px;
      max-height: 180px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 5px;
      object-fit: contain;
      background: white;
      box-shadow: 0 0 5px #bbb;
    }
    label {
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Light Spectrum Analyzer</h1>

  <p class="instructions">
    <strong>Instructions:</strong><br/>
    1. First upload the <em>Blank/Reference</em> image (e.g., white light source or empty cuvette).<br/>
    2. Then upload the <em>Sample</em> image.<br/>
    3. The absorbance graph will be calculated as A = log10(I₀/I), where I₀ is the blank intensity, and I is the sample intensity.<br/>
    4. Absorbance values are clamped between 0 and 1 for visualization.<br/>
    5. The area under the graph is colored according to the corresponding wavelength color.<br/>
    6. Peak wavelength and absorbance are shown in the graph title.<br/>
  </p>

  <div class="preview-container">
    <label for="uploadBlank">Upload Blank (Reference) Image:</label><br/>
    <input type="file" accept="image/*" id="uploadBlank" /><br/>
    <img id="blankPreview" class="preview" alt="Blank Image Preview" />
  </div>

  <div class="preview-container">
    <label for="uploadSample">Upload Sample Image:</label><br/>
    <input type="file" accept="image/*" id="uploadSample" /><br/>
    <img id="samplePreview" class="preview" alt="Sample Image Preview" />
  </div>

  <canvas id="spectrumChart"></canvas>
  <div id="status"></div>

<script>
  const ctx = document.getElementById('spectrumChart').getContext('2d');
  let blankSpectrum = null;
  let sampleSpectrum = null;
  let chartInstance = null;

  function getColor(wavelength) {
    if (wavelength < 380 || wavelength > 750) return 'rgba(0,0,0,0)';
    let r=0, g=0, b=0;
    if (wavelength < 440) {
      r = -(wavelength - 440) / (440 - 380);
      b = 1;
    } else if (wavelength < 490) {
      g = (wavelength - 440) / (490 - 440);
      b = 1;
    } else if (wavelength < 510) {
      g = 1;
      b = -(wavelength - 510) / (510 - 490);
    } else if (wavelength < 580) {
      r = (wavelength - 510) / (580 - 510);
      g = 1;
    } else if (wavelength < 645) {
      r = 1;
      g = -(wavelength - 645) / (645 - 580);
    } else {
      r = 1;
    }
    const saturate = v => Math.min(255, Math.round(v * 1.4));
    return `rgba(${saturate(r*255)},${saturate(g*255)},${saturate(b*255)},0.7)`;
  }

  function analyzeImage(img) {
    const canvas = document.createElement('canvas');
    const ctx2 = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    ctx2.drawImage(img, 0, 0);
    const spectrum = [];
    for (let x = 0; x < img.width; x++) {
      let sum = 0;
      for (let y = 0; y < img.height; y++) {
        const pixel = ctx2.getImageData(x, y, 1, 1).data;
        sum += (pixel[0] + pixel[1] + pixel[2]) / 3;
      }
      spectrum.push(sum / img.height);
    }
    return spectrum;
  }

  function computeAbsorbance(sampleSpec) {
    if (!blankSpectrum) {
      document.getElementById('status').textContent = "Please upload blank/reference image first.";
      return;
    }
    const maxBlank = Math.max(...blankSpectrum);
    if (maxBlank === 0) {
      alert("Blank image is completely dark. Cannot calibrate.");
      return;
    }
    const normalizedBlank = blankSpectrum.map(i => i / maxBlank);
    const normalizedSample = sampleSpec.map(i => i / maxBlank);
    const epsilon = 1e-10;

    const absorbance = normalizedSample.map((I, i) => {
      let I0 = normalizedBlank[i];
      if (I <= 0) I = epsilon;
      if (I0 <= 0) I0 = epsilon;

      let A = Math.log10(I0 / I);
      if (A < 0) A = 0;
      if (A > 1) A = 1;
      return A;
    });

    const labels = absorbance.map((_, i) => Math.round(380 + (i / absorbance.length) * (750 - 380)));
    const peakIndex = absorbance.indexOf(Math.max(...absorbance));
    const peakWavelength = labels[peakIndex];
    const peakValue = absorbance[peakIndex].toFixed(2);

    plotChart(labels, absorbance, peakWavelength, peakValue);
    document.getElementById('status').textContent = `Peak Wavelength: ${peakWavelength} nm | Absorbance: ${peakValue}`;
  }

  function plotChart(labels, absorbance, peakWavelength, peakValue) {
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Absorbance',
          data: absorbance,
          borderColor: 'black',
          borderWidth: 2,
          fill: true,
          backgroundColor: function(context) {
            const chartCtx = context.chart.ctx;
            const chartArea = context.chart.chartArea;
            if (!chartArea) {
              return null;
            }
            const gradient = chartCtx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
            labels.forEach((w, i) => {
              const stop = i / (labels.length - 1);
              gradient.addColorStop(stop, getColor(w));
            });
            return gradient;
          },
          tension: 0.3,
          pointRadius: 0,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Wavelength (nm)'
            },
            min: 380,
            max: 750,
            ticks: {
              maxTicksLimit: 10,
              autoSkip: true
            }
          },
          y: {
            title: {
              display: true,
              text: 'Absorbance (0 to 1)'
            },
            min: 0,
            max: 1,
            ticks: {
              stepSize: 0.1
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: `Peak Wavelength: ${peakWavelength} nm | Absorbance: ${peakValue}`
          },
          tooltip: {
            callbacks: {
              label: ctx => `Absorbance: ${ctx.formattedValue}`
            }
          },
          legend: {
            display: false
          }
        }
      }
    });
  }

  function handleFileInput(event, isBlank) {
    const file = event.target.files[0];
    if (!file) return;

    const img = new Image();
    img.onload = () => {
      if (isBlank) {
        blankSpectrum = analyzeImage(img);
        document.getElementById('blankPreview').src = img.src;
        document.getElementById('status').textContent = "Blank image loaded. Please upload sample image.";
      } else {
        sampleSpectrum = analyzeImage(img);
        document.getElementById('samplePreview').src = img.src;
        computeAbsorbance(sampleSpectrum);
      }
    };
    img.src = URL.createObjectURL(file);
  }

  document.getElementById('uploadBlank').addEventListener('change', e => handleFileInput(e, true));
  document.getElementById('uploadSample').addEventListener('change', e => handleFileInput(e, false));
</script>

</body>
</html>
