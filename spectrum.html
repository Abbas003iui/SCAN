<!DOCTYPE html>
<html>
<head>
  <title>Light Spectrum Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
      background-color: #f0f0f0;
    }
    canvas {
      max-width: 100%;
      margin-top: 20px;
      border: 1px solid #ccc;
      background-color: white;
    }
    input[type="file"] {
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h2>Light Spectrum Analyzer</h2>
  <p>Upload an image of a light source to analyze its spectrum:</p>
  <input type="file" accept="image/*" onchange="loadImage(event)" capture="environment">
  <canvas id="imageCanvas" width="600" height="150"></canvas>
  <canvas id="chartCanvas" width="600" height="350"></canvas>
  <p id="peakInfo"></p>

  <script>
    const imgCanvas = document.getElementById("imageCanvas");
    const imgCtx = imgCanvas.getContext("2d");
    const chartCtx = document.getElementById("chartCanvas").getContext("2d");
    let chart;

    function loadImage(event) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          imgCtx.clearRect(0, 0, imgCanvas.width, imgCanvas.height);
          imgCtx.drawImage(img, 0, 0, imgCanvas.width, imgCanvas.height);
          analyzeSpectrum();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(event.target.files[0]);
    }

    function rgbToWavelength(r, g, b) {
      if (r > g && r > b) return 620 + (r - g - b) * 0.1;
      if (g > r && g > b) return 510 + (g - r - b) * 0.1;
      if (b > r && b > g) return 460 + (b - r - g) * 0.1;
      return 550;
    }

    function analyzeSpectrum() {
      const y = Math.floor(imgCanvas.height / 2);
      const width = imgCanvas.width;
      let spectrum = [];
      let maxIntensity = 0;

      for (let x = 0; x < width; x++) {
        const pixel = imgCtx.getImageData(x, y, 1, 1).data;
        const r = pixel[0], g = pixel[1], b = pixel[2];
        const intensity = (r + g + b) / 3;
        const wavelength = Math.round(rgbToWavelength(r, g, b));
        maxIntensity = Math.max(maxIntensity, intensity);
        spectrum.push({ wavelength, intensity });
      }

      let absorbance = {};
      let counts = {};

      spectrum.forEach(p => {
        const A = -Math.log10((p.intensity + 1) / (maxIntensity + 1)); // avoid log(0)
        if (!absorbance[p.wavelength]) {
          absorbance[p.wavelength] = 0;
          counts[p.wavelength] = 0;
        }
        absorbance[p.wavelength] += A;
        counts[p.wavelength]++;
      });

      let rawLabels = Object.keys(absorbance).map(Number);
      let rawValues = rawLabels.map(w => absorbance[w] / counts[w]);

      // Fill gaps in wavelength range (190–800 nm)
      const fullRange = Array.from({ length: 611 }, (_, i) => i + 190);
      const absorbanceMap = Object.fromEntries(rawLabels.map((w, i) => [w, rawValues[i]]));
      const labels = fullRange;
      const values = fullRange.map(w => absorbanceMap[w] || 0);

      // Find highest absorbance peak
      const peakIndex = values.indexOf(Math.max(...values));
      const peakWavelength = labels[peakIndex];
      const peakAbsorbance = values[peakIndex].toFixed(2);

      document.getElementById("peakInfo").innerText =
        `Highest Absorbance: ${peakAbsorbance} at ${peakWavelength} nm`;

      if (chart) chart.destroy();

      // Color gradient under curve (UV–VIS)
      const gradient = chartCtx.createLinearGradient(0, 0, chartCtx.canvas.width, 0);
      gradient.addColorStop(0.00, "purple");    // 190–380 UV
      gradient.addColorStop(0.15, "violet");    // 380–450
      gradient.addColorStop(0.30, "blue");      // 450–495
      gradient.addColorStop(0.45, "green");     // 495–570
      gradient.addColorStop(0.55, "yellow");    // 570–590
      gradient.addColorStop(0.63, "orange");    // 590–620
      gradient.addColorStop(0.75, "red");       // 620–750
      gradient.addColorStop(1.00, "gray");      // 750–800+

      chart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: "Absorbance Spectrum",
            data: values,
            borderColor: "#000",
            borderWidth: 2,
            fill: true,
            backgroundColor: gradient,
            tension: 0.4,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: {
              title: { display: true, text: "Wavelength (nm)" },
              min: 190,
              max: 800,
              ticks: {
                callback: function(value) {
                  return value + ' nm';
                }
              }
            },
            y: {
              title: { display: true, text: "Absorbance" },
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>
</body>
</html>
