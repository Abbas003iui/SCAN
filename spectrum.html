<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UV-Vis Absorbance Spectrum Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 20px;
      text-align: center;
    }

    #chartContainer {
      width: 90%;
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    input[type="file"] {
      margin: 10px;
    }

    img {
      max-height: 150px;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <h1>ðŸŒˆ UV-Vis Absorbance Analyzer</h1>
  <p>Upload your <strong>blank</strong> and <strong>sample</strong> images below:</p>

  <input type="file" id="blankInput" accept="image/*">
  <input type="file" id="sampleInput" accept="image/*"><br>

  <img id="blankPreview" style="display:none;">
  <img id="samplePreview" style="display:none;">

  <div id="chartContainer">
    <canvas id="spectrumChart"></canvas>
  </div>

  <script>
    let blankSpectrum = null;
    const startWavelength = 380;
    const endWavelength = 750;

    function extractSpectrum(image) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = image.width;
      canvas.height = image.height;
      ctx.drawImage(image, 0, 0);
      const width = canvas.width;
      const height = canvas.height;
      const spectrum = [];

      for (let x = 0; x < width; x++) {
        let total = 0;
        for (let y = 0; y < height; y++) {
          const [r, g, b] = ctx.getImageData(x, y, 1, 1).data;
          const intensity = (r + g + b) / 3;
          total += intensity;
        }
        spectrum.push(total / height);
      }

      return spectrum;
    }

    function wavelengthLabels(length) {
      const labels = [];
      for (let i = 0; i < length; i++) {
        const wl = startWavelength + ((endWavelength - startWavelength) * i / length);
        labels.push(Math.round(wl));
      }
      return labels;
    }

    function computeAbsorbance(blank, sample) {
      const absorbance = [];
      for (let i = 0; i < sample.length; i++) {
        const I0 = blank[i];
        const I = sample[i];

        let A = 0;
        if (I > 0 && I0 > 0 && I < I0) {
          A = Math.log10(I0 / I);
        }

        absorbance.push(Math.min(Math.max(A, 0), 1)); // Clamp between 0â€“1
      }

      return absorbance;
    }

    function wavelengthToColor(wavelength) {
      if (wavelength < 440) return "#8B00FF";
      if (wavelength < 490) return "#0000FF";
      if (wavelength < 510) return "#00FFFF";
      if (wavelength < 580) return "#00FF00";
      if (wavelength < 600) return "#FFFF00";
      if (wavelength < 645) return "#FF7F00";
      return "#FF0000";
    }

    function drawChart(absorbance, labels) {
      const ctx = document.getElementById('spectrumChart').getContext('2d');
      if (window.spectrumChart) window.spectrumChart.destroy();

      const gradient = ctx.createLinearGradient(0, 0, ctx.canvas.width, 0);
      for (let i = 0; i < labels.length; i += Math.floor(labels.length / 10)) {
        const color = wavelengthToColor(labels[i]);
        gradient.addColorStop(i / labels.length, color);
      }

      const peak = Math.max(...absorbance);
      const peakIndex = absorbance.indexOf(peak);
      const peakWavelength = labels[peakIndex];

      window.spectrumChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Absorbance',
            data: absorbance,
            borderColor: 'black',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4, // smooth line (trendline look)
            pointRadius: 0
          }]
        },
        options: {
          scales: {
            x: {
              title: {
                display: true,
                text: 'Wavelength (nm)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Absorbance'
              },
              min: 0,
              max: 1
            }
          },
          plugins: {
            title: {
              display: true,
              text: `Peak Absorbance: ${peak.toFixed(2)} at ${peakWavelength} nm`
            },
            tooltip: {
              callbacks: {
                label: ctx => `A = ${ctx.raw.toFixed(2)} at ${ctx.label} nm`
              }
            }
          }
        }
      });
    }

    function handleFile(input, isBlank) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const spectrum = extractSpectrum(img);
          if (isBlank) {
            blankSpectrum = spectrum;
            document.getElementById('blankPreview').src = img.src;
            document.getElementById('blankPreview').style.display = 'inline';
          } else {
            if (!blankSpectrum || blankSpectrum.length !== spectrum.length) {
              alert("Please upload a valid blank image first.");
              return;
            }
            document.getElementById('samplePreview').src = img.src;
            document.getElementById('samplePreview').style.display = 'inline';

            const absorbance = computeAbsorbance(blankSpectrum, spectrum);
            const labels = wavelengthLabels(absorbance.length);
            drawChart(absorbance, labels);
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    document.getElementById('blankInput').addEventListener('change', () => handleFile(blankInput, true));
    document.getElementById('sampleInput').addEventListener('change', () => handleFile(sampleInput, false));
  </script>

</body>
</html>
