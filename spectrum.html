<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Light Spectrum Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    h1 {
      margin-bottom: 5px;
    }
    .instructions {
      max-width: 700px;
      margin: 10px auto 30px auto;
      background: #fff;
      border-radius: 8px;
      padding: 15px 20px;
      box-shadow: 0 0 10px #ccc;
      font-size: 14px;
      line-height: 1.5;
      text-align: left;
    }
    .upload-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .upload-block {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 0 6px #bbb;
      width: 300px;
    }
    .upload-block label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .upload-block input[type="file"] {
      width: 100%;
      cursor: pointer;
    }
    .preview-img {
      margin-top: 10px;
      max-width: 100%;
      max-height: 180px;
      border: 1px solid #ddd;
      border-radius: 5px;
      object-fit: contain;
      background: #eee;
    }
    #status {
      font-weight: bold;
      margin: 10px 0 20px 0;
      color: #333;
      min-height: 24px;
    }
    /* Fixed canvas container to prevent squishing */
    #chartContainer {
      width: 100%;
      max-width: 900px;
      height: 400px;
      margin: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      padding: 10px;
    }
    canvas#spectrumChart {
      width: 100% !important;
      height: 400px !important;
      max-height: 400px !important;
      min-height: 400px !important;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>

  <h1>Light Spectrum Analyzer</h1>

  <div class="instructions">
    <p><strong>Instructions:</strong></p>
    <ol>
      <li>First, upload a <em>blank</em> image (a reference image without sample) to calibrate the system.</li>
      <li>Next, upload the <em>sample</em> image you want to analyze.</li>
      <li>The absorbance spectrum will be calculated as: <br>
        <code>Absorbance = 1 - (Sample Intensity / Blank Intensity)</code>.<br>
        Values are normalized between 0 and 1.</li>
      <li>The graph shows absorbance vs wavelength (380nm to 750nm), with the area under the curve colored to match the visible spectrum at each wavelength.</li>
      <li>The peak absorbance wavelength is displayed in the chart title.</li>
      <li>You can upload new images anytime to update the analysis.</li>
    </ol>
  </div>

  <div class="upload-container">
    <div class="upload-block">
      <label for="uploadBlank">Upload Blank Image (Reference)</label>
      <input type="file" accept="image/*" id="uploadBlank" />
      <img id="blankPreview" class="preview-img" alt="Blank preview" />
    </div>
    <div class="upload-block">
      <label for="uploadSample">Upload Sample Image</label>
      <input type="file" accept="image/*" id="uploadSample" />
      <img id="samplePreview" class="preview-img" alt="Sample preview" />
    </div>
  </div>

  <div id="status"></div>

  <div id="chartContainer">
    <canvas id="spectrumChart"></canvas>
  </div>

  <script>
    const ctx = document.getElementById('spectrumChart').getContext('2d');

    // Globals to store spectra
    let blankSpectrum = null;
    let sampleSpectrum = null;
    let chartInstance = null;

    // Convert wavelength (nm) to saturated RGB color string
    function getColor(wavelength) {
      // Wavelength range 380-750 nm visible spectrum
      let r = 0, g = 0, b = 0;
      if (wavelength >= 380 && wavelength <= 440) {
        r = -(wavelength - 440) / (440 - 380);
        g = 0;
        b = 1;
      } else if (wavelength <= 490) {
        r = 0;
        g = (wavelength - 440) / (490 - 440);
        b = 1;
      } else if (wavelength <= 510) {
        r = 0;
        g = 1;
        b = -(wavelength - 510) / (510 - 490);
      } else if (wavelength <= 580) {
        r = (wavelength - 510) / (580 - 510);
        g = 1;
        b = 0;
      } else if (wavelength <= 645) {
        r = 1;
        g = -(wavelength - 645) / (645 - 580);
        b = 0;
      } else if (wavelength <= 750) {
        r = 1;
        g = 0;
        b = 0;
      }
      // Full saturation, alpha 0.4 for area fill
      return `rgba(${Math.round(r * 255)},${Math.round(g * 255)},${Math.round(b * 255)},0.4)`;
    }

    // Analyze image pixels to get intensity spectrum (average grayscale by column)
    function analyzeImage(img) {
      const canvas = document.createElement('canvas');
      const ctx2 = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx2.drawImage(img, 0, 0);
      const spectrum = [];
      for (let x = 0; x < img.width; x++) {
        let sum = 0;
        for (let y = 0; y < img.height; y++) {
          const pixel = ctx2.getImageData(x, y, 1, 1).data;
          // Average of R,G,B
          sum += (pixel[0] + pixel[1] + pixel[2]) / 3;
        }
        spectrum.push(sum / img.height);
      }
      return spectrum;
    }

    // Normalize array values to 0-1
    function normalizeArray(arr) {
      const max = Math.max(...arr);
      const min = Math.min(...arr);
      if (max === min) return arr.map(() => 0); // avoid div by zero
      return arr.map(v => (v - min) / (max - min));
    }

    // Compute absorbance = 1 - (sample / blank), clamp 0 to 1
    function computeAbsorbance(sample, blank) {
      const length = Math.min(sample.length, blank.length);
      const absorbance = [];
      for (let i = 0; i < length; i++) {
        let val = 1 - (sample[i] / blank[i]);
        // Clamp between 0 and 1
        if (val < 0) val = 0;
        if (val > 1) val = 1;
        absorbance.push(val);
      }
      return absorbance;
    }

    // Create wavelength labels from 380 to 750 nm based on data length
    function createLabels(length) {
      const start = 380;
      const end = 750;
      const labels = [];
      for (let i = 0; i < length; i++) {
        labels.push(Math.round(start + (i / length) * (end - start)));
      }
      return labels;
    }

    // Draw chart with absorbance data and wavelength colors
    function drawChart(absorbance, labels) {
      if (chartInstance) {
        chartInstance.destroy();
      }

      // Find peak absorbance index and value
      const peakIndex = absorbance.indexOf(Math.max(...absorbance));
      const peakWavelength = labels[peakIndex];
      const peakValue = absorbance[peakIndex].toFixed(3);

      // Dataset background color array matching wavelengths (for area fill)
      const bgColors = labels.map(wl => getColor(wl));

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Normalized Absorbance',
            data: absorbance,
            borderColor: 'black',
            backgroundColor: bgColors,
            fill: true,
            pointRadius: 0,
            tension: 0.3,
            borderWidth: 2,
            segment: {
              borderColor: ctx => {
                // Keep trendline black for all segments
                return 'black';
              }
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: 'Wavelength (nm)' },
              ticks: {
                maxTicksLimit: 12,
                maxRotation: 0,
                minRotation: 0
              },
              min: 380,
              max: 750,
            },
            y: {
              title: { display: true, text: 'Absorbance' },
              min: 0,
              max: 1,
              ticks: {
                stepSize: 0.1
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `Absorbance: ${ctx.formattedValue}`
              }
            },
            title: {
              display: true,
              text: `Peak Wavelength: ${peakWavelength} nm | Absorbance: ${peakValue}`
            }
          }
        }
      });
    }

    // Handle file input for blank or sample image
    function handleFileInput(event, isBlank) {
      const file = event.target.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = () => {
        if (isBlank) {
          blankSpectrum = analyzeImage(img);
          document.getElementById('blankPreview').src = img.src;
          document.getElementById('status').textContent = "Blank image loaded. Please upload sample image.";
          sampleSpectrum = null;
          if(chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
          }
        } else {
          if (!blankSpectrum) {
            document.getElementById('status').textContent = "Please upload blank image first!";
            event.target.value = "";
            return;
          }
          sampleSpectrum = analyzeImage(img);
          document.getElementById('samplePreview').src = img.src;
          // Compute absorbance and draw chart
          const absorbanceRaw = computeAbsorbance(sampleSpectrum, blankSpectrum);
          // Normalize absorbance again for smooth graph (optional)
          // Here we assume values are already clamped 0-1, so no normalization needed
          drawChart(absorbanceRaw, createLabels(absorbanceRaw.length));
          document.getElementById('status').textContent = "Analysis complete.";
        }
      };
      img.onerror = () => {
        document.getElementById('status').textContent = "Failed to load image. Please upload a valid image file.";
      };
      img.src = URL.createObjectURL(file);
    }

    // Event listeners
    document.getElementById('uploadBlank').addEventListener('change', e => handleFileInput(e, true));
    document.getElementById('uploadSample').addEventListener('change', e => handleFileInput(e, false));
  </script>

</body>
</html>
