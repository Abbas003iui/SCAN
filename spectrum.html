<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Spectrometer Analyzer</title>
    <!-- Tailwind (via CDN for quick prototyping) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      #calibCanvas {
        cursor: crosshair;
        max-width: 100%;
        background: #111;
        display: block;
        margin: 0 auto;
        height: 300px;
        width: 100%;
      }
      #graphCanvas {
        width: 100% !important;
        height: 400px !important;
      }
      .line-handle {
        position: absolute;
        top: 0;
        width: 2px;
        background: #f00;
        cursor: ew-resize;
        mix-blend-mode: difference;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 antialiased min-h-screen flex flex-col items-center p-4">
    <h1 class="text-3xl font-bold mb-4 text-center">Web Color Spectrometer Analyzer</h1>

    <!-- Step 1: Calibration -->
    <section class="w-full max-w-4xl mb-8">
      <h2 class="text-xl font-semibold mb-2">1. Calibration</h2>
      <div class="mb-2 space-y-2">
        <input
          type="file"
          id="calibImageInput"
          accept="image/*"
          class="file:mr-4 file:bg-indigo-600 file:text-white file:px-3 file:py-1 file:rounded hover:file:bg-indigo-500 transition"
        />
        <div class="flex flex-wrap gap-4 items-center">
          <div>
            <label class="text-sm mr-1">λ<sub>1</sub> (nm):</label>
            <input id="lambda1" type="number" value="400" class="bg-gray-800 p-1 rounded w-24" />
          </div>
          <div>
            <label class="text-sm mr-1">λ<sub>2</sub> (nm):</label>
            <input id="lambda2" type="number" value="700" class="bg-gray-800 p-1 rounded w-24" />
          </div>
          <button
            id="saveCalibBtn"
            class="bg-green-600 px-4 py-2 rounded hover:bg-green-500 disabled:opacity-40"
            disabled
          >
            Save Calibration
          </button>
        </div>
        <p class="text-sm text-gray-400">Drag the red vertical lines to align known wavelengths, then enter their values and click <strong>Save Calibration</strong>. The absorbance graph below will show the spectrum from the calibration image itself.</p>
      </div>
      <div class="relative overflow-x-auto">
        <canvas id="calibCanvas"></canvas>
        <div id="line1" class="line-handle hidden"></div>
        <div id="line2" class="line-handle hidden"></div>
      </div>
    </section>

    <!-- Step 2: Blank Spectrum -->
    <section class="w-full max-w-4xl mb-8">
      <h2 class="text-xl font-semibold mb-2">2. Blank Spectrum</h2>
      <input
        type="file"
        id="blankImageInput"
        accept="image/*"
        class="file:mr-4 file:bg-indigo-600 file:text-white file:px-3 file:py-1 file:rounded hover:file:bg-indigo-500 transition"
        disabled
      />
    </section>

    <!-- Step 3: Sample Spectrum -->
    <section class="w-full max-w-4xl mb-8">
      <h2 class="text-xl font-semibold mb-2">3. Sample Spectrum</h2>
      <input
        type="file"
        id="sampleImageInput"
        accept="image/*"
        class="file:mr-4 file:bg-indigo-600 file:text-white file:px-3 file:py-1 file:rounded hover:file:bg-indigo-500 transition"
        disabled
      />
    </section>

    <!-- Step 4: Absorbance Graph -->
    <section class="w-full max-w-4xl mb-8">
      <h2 class="text-xl font-semibold mb-2">4. Absorbance vs. Wavelength</h2>
      <canvas id="graphCanvas" class="bg-gray-800 rounded shadow"></canvas>
    </section>

    <footer class="text-xs text-gray-500 mt-auto text-center">
      © <span id="year"></span> Web Spectrometer Analyzer · Inspired by Theremino Spectrometer
    </footer>

    <script>
const calibCanvas = document.getElementById('calibCanvas');
const calibCtx = calibCanvas.getContext('2d');
const calibInput = document.getElementById('calibImageInput');
const saveCalibBtn = document.getElementById('saveCalibBtn');
const lambda1 = document.getElementById('lambda1');
const lambda2 = document.getElementById('lambda2');
const line1 = document.getElementById('line1');
const line2 = document.getElementById('line2');
const graphCanvas = document.getElementById('graphCanvas');
let chart;

let img = new Image();
let imgLoaded = false;
let x1 = 100, x2 = 300;
let dragging = null;

function drawLines() {
  line1.style.left = `${x1}px`;
  line2.style.left = `${x2}px`;
  line1.classList.remove('hidden');
  line2.classList.remove('hidden');
}

function getIntensityProfile() {
  const data = calibCtx.getImageData(0, calibCanvas.height / 2, calibCanvas.width, 1).data;
  const intensity = [];
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i], g = data[i+1], b = data[i+2];
    const avg = (r + g + b) / 3 / 255;
    intensity.push(avg);
  }
  return intensity;
}

function plotCalibration(intensity) {
  const nm1 = parseFloat(lambda1.value);
  const nm2 = parseFloat(lambda2.value);
  const width = intensity.length;
  const scale = (nm2 - nm1) / (x2 - x1);
  const offset = nm1 - x1 * scale;

  const wavelengths = intensity.map((_, i) => offset + i * scale);
  const absorbance = intensity.map(v => 1 - v);

  if (chart) chart.destroy();
  chart = new Chart(graphCanvas, {
    type: 'line',
    data: {
      labels: wavelengths,
      datasets: [{
        label: 'Absorbance',
        data: absorbance,
        borderColor: 'cyan',
        borderWidth: 2,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          type: 'linear',
          title: { display: true, text: 'Wavelength (nm)' },
        },
        y: {
          min: 0, max: 1,
          title: { display: true, text: 'Absorbance' }
        }
      }
    }
  });
}

saveCalibBtn.addEventListener('click', () => {
  if (!imgLoaded) return;
  const intensity = getIntensityProfile();
  plotCalibration(intensity);
});

calibInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    img.onload = () => {
      calibCanvas.width = img.width;
      calibCanvas.height = img.height;
      calibCtx.drawImage(img, 0, 0);
      drawLines();
      saveCalibBtn.disabled = false;
      imgLoaded = true;
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
});

[line1, line2].forEach((line, idx) => {
  line.addEventListener('mousedown', () => {
    dragging = idx;
  });
});

window.addEventListener('mousemove', (e) => {
  if (dragging === null) return;
  const rect = calibCanvas.getBoundingClientRect();
  const x = Math.min(Math.max(0, e.clientX - rect.left), calibCanvas.width);
  if (dragging === 0) x1 = x;
  if (dragging === 1) x2 = x;
  drawLines();
});

window.addEventListener('mouseup', () => {
  dragging = null;
});

document.getElementById('year').textContent = new Date().getFullYear();
</script>
  </body>
</html>
